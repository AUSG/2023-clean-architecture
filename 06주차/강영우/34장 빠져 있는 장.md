# 34장 빠져 있는 장

# 계층 기반 패키지

---

- 전통적인 수평 계층형 아키텍처
- 해단 코드가 하는 일에 기반해 그 코드를 분할한다.
- 이 아키텍처에는 웹, ‘업무 규칙’, 영속성 코드를 위해 계층이 하나씩 존재한다.
- 처음 시작하기에는 계층형 아키텍처가 적합함. 하지만 소프트웨어가 커지고 복잡해지면 이로는 감당할 수 없다.

# 기능 기반 패키지

---

- 서로 연관된 기능, 도메인 개념, Aggregate Root에 기반해 수직의 얇은 조각으로 코드를 나눈다.
- 여러개의 계층이 한 패키지 안에 들어가있다.
- 장점
    - 상위 수준 구조가 업무 도메인이 뭔지 알려준다.
    - 관련 작업 코드찾기가 더 쉬워진다.
- 보통 수평(계층 기반 패키지)에서 수직(기능 기반 패키지)로 자주 전환한다.

# 포트와 어댑터

---

- 업무/도메인에 초점을 둔 코드가 프레임워크나 데이터베이스 같은 기술적인 세부 구현과 독립적이며 분리된 아키텍처를 만들기 위해 사용
- 코드베이스는 내부(도메인)과 외부(인프라)로 구성된다.
- 외부는 내부에 의존하며, 절대 그 반대는 안된다.
- repository라는 이름을 사용 안하는데, 이것은 도메인에 대해 논의할 때 도메인 그 자체를 말하는 것이지 repository를 말하는 것이 아니기 때문

# 컴포넌트 기반 패키지

---

- 계층형 아키텍처처럼 모든 계층을 나누면 내부 인터페이스는 public으로 되어야 다른 패키지에서 참조가 가능하고, 이것은 좋지 않은 방향이다.
- 그리고 controller에서 service를 건너뛰고 repository를 바라보기도 하는데, 이것은 특수한 경우가 아니고서야 안티패턴이다.
    - 이를 피하기 위해 내부 규칙을 만들어야하고, 정적 코드 분석을 해서 미연에 방지해야한다.
- 위 문제를 풀기 위해 관련된 모든 책임을 하나의 패키지로 묶는데 주안점을 둔다.
- 컴포넌트: 멋지고 깔끔한 인터페이스로 감싸진 연관된 기능들의 묶음. 애플리케이션과 같은 실행환경 내부에 존재한다.
- 장점
    - 어떤 도메인에 해당하는 코드를 수정해야할 때 한 컴포넌트만 보면 된다.
    - 컴포넌트의 내부에서 관심사 분리는 여전하므로  영속성 저장과 업무 규칙은 분리되어있다.
- 모놀리식 애플리케이션에서 컴포넌트를 잘 정의하면 마이크로 서비스 아키텍처로 가기쉽다.

# 구현 세부사항엔 항상 문제가 있다.

---

- 위 네가지 구현 아키텍처에 세부사항을 잘 구현해야한다.
- public 마구잡이로 쓰면 객체지향의 큰 이점을 사용하지 않는 것이다.

# 조직화 vs 캡슐화

---

- public을 마구잡이로 사용하면 패키지를 나누는 것과 안나누는 것 의미가 없다.
- 접근 지시자를 적절하게 사용하면 타입을 패키지로 배치하는 방식에 따라서 각 타입에 접근할 수 있는 정도가 크게 달라질 수 있다.
- 모놀리식 애플리케이션을 구현중이라면 자기규율이나 컴파일 후 처리를 하지말고 컴파일러에 의지해라.

# 다른 결합 분리 모드

---

- 모듈 시스템을 사용해 소스코드 의존성을 분리할 수 있다.
- 소스코드 수준에서 의존성을 분리할 수 있다.
    - 업무와 도메인용 소스코드
    - 웹용 소스코드
    - 데이터 영속성용 소스코드
    - → 하지만 너무 복잡해지고 성능, 복잡성, 유지보수 이슈가 생긴다.
- 포트와 어댑터 접근법에서는 소스트리를 두개만 만든다.
    - 도메인 코드(’내부’)
    - 인프라 코드(’외부’)
    - 인프라는 도메인에 대해 컴파일 시점의 의존성을 가진다.
- 포트와 어댑터 접근법에서는 절충하는 부분이 필요하다.
    - ‘포트와 어댑터에 대한 페리페리크 안티 패턴’
    - 특정 영역의 인프라 코드가 다른 특정 영역의 인프라 코드를 도메인을 통하지 않고 우회해서 직접 호출하는 경우

# 결론: 빠져 있는 조언

---

- 최적의 설계를 했더라도, 구현 전략에 얽힌 복잡함을 고려하지 않으면 설계가 순식간에 망가질 수도 있다.
- 가능하다면 선택사항을 열어두되, 실용주의적으로 행하라.
- 팀의 규모, 기술 수준, 해결책의 복잡성을 일정과 예산이라는 제약과 동시에 고려하라.
- 아키텍처 스타일을 강제하는 데 컴파일러의 도움을 받을 수 있을지 고민하라.
- 데이터 모델과 같은 다른 영역에 결합되지 않도록 주의하라.